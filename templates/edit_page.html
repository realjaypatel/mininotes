{% extends "base.html" %}
{% block title %}Edit Page{% endblock %}

{% block header %}
<header class="masthead" style="background-image: url('{{ page.bgimg or url_for('static', filename='assets/img/about-bg.jpg') }}')">
  <div class="container position-relative px-4 px-lg-5">
    <div class="row gx-4 gx-lg-5 justify-content-center">
      <div class="col-12 text-center text-white">
        <!-- Empty header -->
      </div>
    </div>
  </div>
</header>
{% endblock %}

{% block content %}
<div class="container px-4 px-lg-5 mt-5">
  <form method="POST" id="form">
    <!-- Title -->
    <div class="form-group mb-3">
      <input type="text" class="form-control form-control-plaintext title-input" name="title" placeholder="Page title" value="{{ page.title }}" required>
    </div>

    <!-- Subtitle -->
    <div class="form-group mb-3">
      <input type="text" class="form-control form-control-plaintext" name="subtitle" placeholder="Subtitle / Headline" value="{{ page.subtitle }}">
    </div>

    <!-- Content -->
    <div class="form-group mb-3">
      <textarea id="content" name="content" class="form-control form-control-plaintext" rows="10" required>{{ page.content }}</textarea>
    </div>

    <!-- Category -->
    <div class="form-group mb-3">
      <input type="text" name="category" id="category" class="form-control form-control-plaintext" placeholder="Enter category" value="{{ page.category }}" required>
    </div>

    <!-- Ticket Fields: Assign By / Assign To -->
    <div id="ticket-fields" style="display:none;">
      <div class="form-group mb-3">
        <input type="text" class="form-control form-control-plaintext" name="assign_by" placeholder="Assign By" value="{{ page.assign_by }}">
      </div>
      <div class="form-group mb-3">
        <input type="text" class="form-control form-control-plaintext" name="assign_to" placeholder="Assign To" value="{{ page.assign_to }}">
      </div>
    </div>

    <!-- Visibility -->
    <div class="form-group mb-3">
      <select name="visibility" class="form-select form-select-plaintext" required>
        <option value="Team" {% if page.visibility == 'Team' %}selected{% endif %}>Team</option>
        <option value="Public" {% if page.visibility == 'Public' %}selected{% endif %}>Public</option>
      </select>
    </div>

    <!-- Status -->
    <div class="form-group mb-3">
      <select name="status" class="form-select form-select-plaintext">
        <option value="pending" {% if page.status == 'pending' %}selected{% endif %}>Pending</option>
        <option value="completed" {% if page.status == 'completed' %}selected{% endif %}>Completed</option>
      </select>
    </div>

    <!-- Background Image -->
    <div class="form-group mb-3">
      <input type="file" class="form-control form-control-plaintext" id="bgimg_file" accept="image/*">
      <input type="hidden" id="bgimg" name="bgimg" value="{{ page.bgimg }}">
    </div>

    <button class="btn btn-primary mt-3">Update Page</button>
  </form>
</div>

<!-- Summernote & Image Upload JS -->
<link href="https://cdn.jsdelivr.net/npm/summernote@0.8.20/dist/summernote.min.css" rel="stylesheet">
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/summernote@0.8.20/dist/summernote.min.js"></script>

<script>
$(document).ready(function() {
    $('#content').summernote({ height: 400 });

    // Convert uploaded background image to base64
    $('#bgimg_file').on('change', function(event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                $('#bgimg').val(e.target.result);
            };
            reader.readAsDataURL(file);
        }
    });

    // Show ticket fields if category is Ticket
    function toggleTicketFields() {
        const val = $('#category').val().trim().toLowerCase();
        if (val === 'ticket') {
            $('#ticket-fields').show();
        } else {
            $('#ticket-fields').hide();
        }
    }

    $('#category').on('input', toggleTicketFields);

    // Trigger on page load
    toggleTicketFields();
});
</script>

<style>
#form {
    margin: 20px auto;
    width: 100%;
    max-width: none;
    padding: 20px;
    border-radius: 8px;
    background-color: #f9f9f9;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}

.title-input {
    font-size: 2.5rem;
    font-weight: bold;
    padding: 10px 0;
}

/* Confluence-style inputs */
.form-control-plaintext {
    border: none;
    background-color: transparent;
    border-bottom: 1px solid #ddd;
    border-radius: 0;
    padding-left: 0;
    padding-right: 0;
}

.form-control-plaintext:focus {
    outline: none;
    border-bottom: 2px solid #0d6efd;
    background-color: transparent;
    box-shadow: none;
}

.form-select-plaintext {
    border: none;
    background-color: transparent;
    border-bottom: 1px solid #ddd;
    border-radius: 0;
    padding-left: 0;
    padding-right: 0;
}

.form-select-plaintext:focus {
    outline: none;
    border-bottom: 2px solid #0d6efd;
    box-shadow: none;
}

@media (min-width: 992px) {
    header.masthead {
        padding-top: 3rem;
        padding-bottom: 1rem;
    }
}
</style>
{% endblock %}
